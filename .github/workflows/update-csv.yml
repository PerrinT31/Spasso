# .github/workflows/update-stock-csv.yml
name: Mise à jour quotidienne du CSV Stock Web Spasso

on:
  schedule:
    # Exécution chaque jour à 04h00 UTC
    - cron: '0 4 * * *'
  workflow_dispatch:  # permet aussi de lancer manuellement depuis l’UI

jobs:
  update-stock-csv:
    runs-on: ubuntu-latest

    steps:
      # 1) Checkout avec l’historique complet pour le rebase
      - name: Checkout
        uses: actions/checkout@v3
        with:
          persist-credentials: true  # pour pousser avec GITHUB_TOKEN
          fetch-depth: 0             # nécessaire pour git pull --rebase

      # 2) Télécharger le CSV Stock Web
      - name: Télécharger le CSV SPASSO_STOCKWEB_SP.csv
        run: |
          curl -fsSL "https://files.karibanbrands.com/documents/SPASSO_STOCKWEB_SP.csv" \
            -o public/SPASSO_STOCKWEB_SP.csv

      # 3) Commit & push si le fichier a changé (avec rebase pour éviter le non-fast-forward)
      - name: Commit & push si modifié
        run: |
          git config user.name  "${{ github.actor }}"
          git config user.email "${{ github.actor }}@users.noreply.github.com"

          git add public/SPASSO_STOCKWEB_SP.csv

          if git diff --cached --quiet; then
            echo "Aucun changement détecté – pas de commit."
            exit 0
          fi

          # Mettre à jour la branche locale pour éviter le rejet non-fast-forward
          git pull --rebase origin main

          git commit -m "Mise à jour quotidienne du CSV Stock Web Spasso"
          git push origin main
